[Main](../README.md)
---

## **Lesson Plan: System Management & Automation**

### **1. Managing System Services with systemd**

**Useful Information:**
* **systemd** is the init system and service manager for most modern Linux distributions.
* It provides a standardized way to manage system services, daemons, and other units.
* **Units** are resources that systemd knows how to manage (services, sockets, mounts, etc.).
* Key concepts: **Units**, **Targets** (similar to runlevels), **Dependencies**.

**Essential Commands & Practice:**

```bash
# View the status of a service
systemctl status ssh          # Check SSH service status
systemctl status nginx        # Check nginx (if installed)

# Start, stop, restart, and reload services
sudo systemctl start ssh      # Start the SSH service
sudo systemctl stop ssh       # Stop the SSH service
sudo systemctl restart ssh    # Restart the service completely
sudo systemctl reload ssh     # Reload configuration without restart

# Enable/disable services to start at boot
sudo systemctl enable ssh     # Enable service to start at boot
sudo systemctl disable ssh    # Disable automatic start at boot
sudo systemctl is-enabled ssh # Check if service is enabled

# List all units
systemctl list-units          # List active units
systemctl list-units --all    # List all units (including inactive)
systemctl list-unit-files     # List unit files and their states

# Practice Task 1:
# 1. Check the status of the SSH service. Is it active and enabled?
# 2. If you have nginx installed, restart it. If not, choose another service like 'cron'.
# 3. Create a simple service file in /etc/systemd/system/ (instructor demo)
```

**Creating a Simple Service (Instructor Demo):**

```bash
# As root, create a simple service
sudo nano /etc/systemd/system/hello.service
```

```ini
[Unit]
Description=Hello World Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do echo "Hello World $(date)" >> /tmp/hello.log; sleep 10; done'
User=student1
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# Reload systemd and manage the service
sudo systemctl daemon-reload
sudo systemctl start hello.service
sudo systemctl status hello.service
tail -f /tmp/hello.log  # Watch the output
sudo systemctl stop hello.service
```

**Best Practices:**
* Use `systemctl status` as your first troubleshooting step.
* Prefer `reload` over `restart` when possible to minimize downtime.
* Always run `systemctl daemon-reload` after modifying service files.
* Use `journalctl -u service-name` to view service logs.

**Use Cases:**
* Managing web servers (nginx, Apache)
* Database services (MySQL, PostgreSQL)
* Custom application services
* Scheduled tasks (though cron is often better for one-off tasks)

---

### **2. Shell Scripting Basics & Syntax**

**Useful Information:**
* Shell scripts are text files containing sequences of shell commands.
* They automate repetitive tasks and create complex workflows.
* The **shebang** (`#!/bin/bash`) tells the system which interpreter to use.
* Scripts must be **executable** (`chmod +x script.sh`).

**Basic Script Structure & Practice:**

Create `~/scripting/hello.sh`:

```bash
#!/bin/bash
# This is a comment
echo "Hello, World!"
echo "Today is: $(date)"
echo "Current user: $(whoami)"
echo "Working directory: $(pwd)"
```

```bash
# Make it executable and run
chmod +x hello.sh
./hello.sh
```

**Variables and User Input:**

Create `~/scripting/variables.sh`:

```bash
#!/bin/bash
# Variable assignment
NAME="Student"
COURSE="Linux Fundamentals"

# Using variables
echo "Welcome, $NAME!"
echo "You are learning $COURSE"

# Command substitution
CURRENT_DIR=$(pwd)
echo "Script is running from: $CURRENT_DIR"

# User input
echo "What's your favorite programming language?"
read FAV_LANG
echo "Wow, $FAV_LANG is awesome!"

# Positional parameters
echo "Script name: $0"
echo "First argument: $1"
echo "All arguments: $@"
```

```bash
# Run with arguments
chmod +x variables.sh
./variables.sh Bash Python Java
```

**Conditional Statements:**

Create `~/scripting/conditions.sh`:

```bash
#!/bin/bash
# Basic if statement
echo "Enter a number:"
read NUMBER

if [ $NUMBER -gt 10 ]; then
    echo "$NUMBER is greater than 10"
elif [ $NUMBER -eq 10 ]; then
    echo "$NUMBER is exactly 10"
else
    echo "$NUMBER is less than 10"
fi

# File conditions
if [ -f "/etc/passwd" ]; then
    echo "/etc/passwd exists and is a regular file"
fi

if [ -d "$HOME" ]; then
    echo "$HOME exists and is a directory"
fi

# String comparison
echo "Enter your name:"
read USERNAME

if [ "$USERNAME" = "admin" ]; then
    echo "Welcome, administrator!"
else
    echo "Hello, $USERNAME"
fi
```

**Practice Task 2:**
1. Create a script `user_info.sh` that:
   - Asks for the user's name and age
   - Checks if the user is over 18 and displays an appropriate message
   - Creates a directory with the user's name if it doesn't exist
   - Creates a file `welcome.txt` in that directory with a personalized greeting

**Best Practices:**
* Always start with `#!/bin/bash`
* Use meaningful variable names
* Quote variables to handle spaces: `"$VARIABLE"`
* Use `[[ ]]` for extended test functionality in bash
* Add comments for complex logic

---

### **3. Loops & Functions**

**Loops in Shell Scripting:**

Create `~/scripting/loops.sh`:

```bash
#!/bin/bash
# For loop with list
echo "Counting to 5:"
for i in 1 2 3 4 5; do
    echo "Number: $i"
done

# For loop with sequence
for i in {1..5}; do
    echo "Sequence: $i"
done

# For loop with files
echo "Text files in current directory:"
for file in *.txt; do
    echo "Found: $file"
done

# While loop
COUNT=1
echo "Counting to 3 with while loop:"
while [ $COUNT -le 3 ]; do
    echo "Count: $COUNT"
    COUNT=$((COUNT + 1))
done

# Reading lines from a file
echo "Reading from /etc/passwd (first 5 lines):"
head -5 /etc/passwd | while read LINE; do
    echo "Line: $LINE"
done
```

**Functions in Shell Scripting:**

Create `~/scripting/functions.sh`:

```bash
#!/bin/bash
# Basic function
greet() {
    echo "Hello, $1!"
    echo "Today is $(date)"
}

# Function with return value
add_numbers() {
    local result=$(( $1 + $2 ))
    echo $result  # This is how we "return" a value
}

# Function that checks if a file exists
check_file() {
    local filename=$1
    if [ -f "$filename" ]; then
        echo "File $filename exists"
        return 0
    else
        echo "File $filename does not exist"
        return 1
    fi
}

# Using functions
greet "Student"

SUM=$(add_numbers 5 3)
echo "5 + 3 = $SUM"

check_file "/etc/passwd"
check_file "/nonexistent/file.txt"
```

**Practical Example - Backup Script:**

Create `~/scripting/backup.sh`:

```bash
#!/bin/bash
# Simple backup script with functions

# Configuration
BACKUP_DIR="$HOME/backups"
SOURCE_DIR="$HOME/important_files"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="backup_$TIMESTAMP.tar.gz"

# Function to create backup
create_backup() {
    echo "Starting backup..."
    
    # Create backup directory if it doesn't exist
    if [ ! -d "$BACKUP_DIR" ]; then
        mkdir -p "$BACKUP_DIR"
        echo "Created backup directory: $BACKUP_DIR"
    fi
    
    # Check if source directory exists
    if [ ! -d "$SOURCE_DIR" ]; then
        echo "Error: Source directory $SOURCE_DIR does not exist!"
        return 1
    fi
    
    # Create tar archive
    tar -czf "$BACKUP_DIR/$BACKUP_FILE" -C "$(dirname "$SOURCE_DIR")" "$(basename "$SOURCE_DIR")"
    
    if [ $? -eq 0 ]; then
        echo "Backup created successfully: $BACKUP_DIR/$BACKUP_FILE"
        return 0
    else
        echo "Backup failed!"
        return 1
    fi
}

# Function to list backups
list_backups() {
    echo "Available backups:"
    ls -la "$BACKUP_DIR"/*.tar.gz 2>/dev/null || echo "No backups found"
}

# Function to display usage
show_help() {
    echo "Usage: $0 [OPTION]"
    echo "Options:"
    echo "  create    Create a new backup"
    echo "  list      List existing backups"
    echo "  help      Show this help message"
}

# Main script logic
case "$1" in
    "create")
        create_backup
        ;;
    "list")
        list_backups
        ;;
    "help"|"")
        show_help
        ;;
    *)
        echo "Unknown option: $1"
        show_help
        exit 1
        ;;
esac
```

**Practice Task 3:**
1. Create a script `system_check.sh` that:
   - Uses a function to check disk usage and warns if usage is over 80%
   - Uses a loop to check if essential services (ssh, cron) are running
   - Creates a log file with the check results and timestamp
   - Uses a function to display a summary report

**Best Practices:**
* Use `local` variables in functions to avoid side effects
* Return meaningful exit codes (0 for success, non-zero for errors)
* Use functions to organize code and avoid repetition
* Validate input parameters in functions
* Use `set -e` to exit on error in critical scripts

---

## **Homework Assignment: System Automation**

**Instructions:** Complete the following tasks and place all scripts in `~/homework_automation/`. Create a `README.md` explaining what each script does.

**Tasks:**

1. **Service Management Script (25 points)**
   Create a script `service_manager.sh` that:
   - Accepts a service name as argument (e.g., `./service_manager.sh ssh`)
   - Checks if the service exists and is installed
   - Displays current status of the service
   - Provides options to start, stop, restart, or check status
   - Uses functions for each operation
   - Has proper error handling and user feedback

2. **User Account Monitor (30 points)**
   Create a script `user_monitor.sh` that:
   - Lists all regular users on the system (UID >= 1000)
   - For each user, checks if their home directory exists
   - Reports disk usage of each home directory
   - Identifies users who haven't logged in for more than 30 days
   - Generates a summary report in a file `user_report_$(date +%Y%m%d).txt`

3. **Backup Automation System (45 points)**
   Create a comprehensive backup script `auto_backup.sh` with:
   - **Function** to backup a specific directory
   - **Function** to rotate old backups (keep only last 5)
   - **Loop** to process multiple directories from a configuration file
   - **Conditional** checks for disk space before backup
   - Logging with timestamps
   - Email notification simulation (just echo a message)

   Configuration file `backup_config.txt` should contain:
   ```
   /home/student1/important_docs
   /home/student1/scripts
   /opt/linux_course
   ```

**Example Starter for service_manager.sh:**
```bash
#!/bin/bash

SERVICE_NAME=$1
ACTION=$2

check_service_exists() {
    # TODO: Check if service exists
}

service_status() {
    # TODO: Show service status
}

# Main logic
case $ACTION in
    "status")
        service_status
        ;;
    # TODO: Add other cases
esac
```

**Submission Requirements:**
- All scripts must be executable and properly commented
- Include a `README.md` with usage instructions
- Test your scripts and document any issues
- Place everything in `~/homework_automation/`

**Bonus Challenge:** 
Create a systemd service unit that runs your backup script weekly and a timer unit to schedule it.

This homework will test their understanding of systemd management, shell scripting fundamentals, loops, functions, and practical automation skills!

[Main](../README.md)
---