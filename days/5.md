[Main](../README.md)
---

## **Lesson Plan: Storage Management**

### **1. Disk Partitioning & File Systems**

**Useful Information:**
* **Partitioning:** Dividing a physical disk into logical sections
* **MBR (Master Boot Record):** Legacy partitioning scheme (up to 2TB, 4 primary partitions)
* **GPT (GUID Partition Table):** Modern standard (supports >2TB, up to 128 partitions)
* **File System:** Method for storing and organizing files (ext4, XFS, Btrfs, etc.)

**Disk Identification and Inspection:**

```bash
# List all block devices
lsblk                          # Tree view of block devices
fdisk -l                       # Detailed partition information
lsblk -f                       # Show file systems and UUIDs

# Get detailed disk information
sudo hdparm -I /dev/sda        # Detailed disk info (if available)
sudo smartctl -a /dev/sda      # SMART data (install smartmontools)

# Practice Task 1:
# 1. List all block devices and identify your main disk
# 2. Check the file system type of your root partition
# 3. Note the sizes and mount points of each partition
```

**Disk Partitioning with fdisk (MBR):**

```bash
# Using fdisk for MBR partitioning
sudo fdisk /dev/sdb            # Start fdisk for /dev/sdb

# Common fdisk commands:
# n - new partition
# p - print partition table
# d - delete partition
# t - change partition type
# w - write changes and exit
# q - quit without saving

# Practice Task 2:
# 1. Start fdisk on a practice disk (e.g., /dev/sdb)
# 2. Create a new primary partition using entire disk
# 3. Set the partition type to Linux (83)
# 4. Write changes and verify with lsblk
```

**Disk Partitioning with gdisk (GPT):**

```bash
# Using gdisk for GPT partitioning
sudo gdisk /dev/sdb            # Start gdisk for GPT partitioning

# Common gdisk commands (similar to fdisk):
# n - new partition
# p - print partition table
# d - delete partition
# t - change partition type
# w - write changes and exit
# q - quit without saving

# Practice Task 3:
# 1. Use gdisk to create a GPT partition table
# 2. Create two partitions: 500MB and the rest of the disk
# 3. Set first partition as EFI System (ef00) and second as Linux (8300)
# 4. Write changes and verify
```

**File System Creation and Management:**

```bash
# Creating file systems
sudo mkfs.ext4 /dev/sdb1       # Create ext4 file system
sudo mkfs.xfs /dev/sdb2        # Create XFS file system
sudo mkfs.vfat /dev/sdb1       # Create FAT32 file system

# File system checking and repair
sudo fsck /dev/sdb1            # Check and repair file system
sudo xfs_repair /dev/sdb2      # Repair XFS file system

# File system information
df -h                          # Show disk space usage
df -i                          # Show inode usage
du -sh /path                   # Show directory size
du -h --max-depth=1 /path      # Show sizes of first-level directories

# Practice Task 4:
# 1. Create an ext4 file system on your first practice partition
# 2. Create an XFS file system on your second partition
# 3. Check the file systems for errors
# 4. Use df to verify the new file systems are ready
```

**Mounting and Automounting:**

```bash
# Manual mounting
sudo mkdir /mnt/mydata
sudo mount /dev/sdb1 /mnt/mydata
sudo umount /mnt/mydata

# Mount with specific options
sudo mount -o rw,noatime /dev/sdb1 /mnt/mydata

# Permanent mounting via /etc/fstab
sudo blkid /dev/sdb1           # Get UUID for fstab
sudo nano /etc/fstab

# Add line to /etc/fstab:
# UUID=1234-5678 /mnt/mydata ext4 defaults 0 2

# Test fstab entry
sudo mount -a                  # Mount all fstab entries

# Practice Task 5:
# 1. Create mount points: /mnt/ext4_data and /mnt/xfs_data
# 2. Manually mount your partitions to these directories
# 3. Copy some files to test the mounts
# 4. Add both partitions to /etc/fstab for automatic mounting at boot
# 5. Test with 'mount -a'
```

**Best Practices:**
* Use GPT for new disks, especially those larger than 2TB
* Choose XFS for large files and high performance, ext4 for general use
* Always use UUIDs in /etc/fstab instead of device names
* Regularly check disk health with SMART tools
* Monitor disk space and inode usage proactively

---

### **2. LVM – Logical Volume Management**

**Useful Information:**
* **LVM** provides abstraction layer between physical storage and file systems
* **Physical Volume (PV):** Physical disk or partition
* **Volume Group (VG):** Pool of physical volumes
* **Logical Volume (LV):** Virtual partition created from volume group
* Benefits: Resizing, snapshots, striping, mirroring

**LVM Components and Concepts:**

```
Physical Disks → Physical Volumes (PV) → Volume Group (VG) → Logical Volumes (LV) → File Systems
```

**LVM Setup Practice:**

```bash
# Create Physical Volumes (PV)
sudo pvcreate /dev/sdb /dev/sdc           # Use entire disks
sudo pvcreate /dev/sdb1 /dev/sdc1         # Or use partitions

# Display physical volumes
sudo pvs                                   # Brief overview
sudo pvdisplay                            # Detailed information

# Practice Task 6:
# 1. Create physical volumes from your practice disks
# 2. Verify with pvs and pvdisplay
# 3. Note the PSize and PFree values
```

**Volume Group Management:**

```bash
# Create Volume Group (VG)
sudo vgcreate my_vg /dev/sdb /dev/sdc

# Extend Volume Group
sudo vgextend my_vg /dev/sdd

# Reduce Volume Group (remove PV)
sudo vgreduce my_vg /dev/sdd

# Display volume groups
sudo vgs
sudo vgdisplay

# Practice Task 7:
# 1. Create a volume group named 'student_vg' with your physical volumes
# 2. Verify the volume group creation
# 3. Check the total size and free space in the VG
```

**Logical Volume Management:**

```bash
# Create Logical Volume (LV)
sudo lvcreate -L 1G -n my_lv my_vg        # Create 1GB LV
sudo lvcreate -l 100%FREE -n big_lv my_vg # Use all free space

# Display logical volumes
sudo lvs
sudo lvdisplay

# Create file system on LV
sudo mkfs.ext4 /dev/my_vg/my_lv

# Mount the logical volume
sudo mkdir /mnt/lvm_data
sudo mount /dev/my_vg/my_lv /mnt/lvm_data

# Practice Task 8:
# 1. Create a 500MB logical volume named 'home_lv'
# 2. Create an ext4 file system on it
# 3. Mount it at /mnt/lvm_home
# 4. Verify everything is working
```

**LVM Resizing Operations:**

```bash
# Extend Logical Volume (add 500MB)
sudo lvextend -L +500M /dev/my_vg/my_lv

# Resize the file system (ext4 example)
sudo resize2fs /dev/my_vg/my_lv

# Reduce Logical Volume (shrink by 200MB - DANGEROUS!)
# First, shrink file system, then LV
sudo umount /mnt/lvm_data
sudo e2fsck -f /dev/my_vg/my_lv           # Force check
sudo resize2fs /dev/my_vg/my_lv 800M      # Shrink FS to 800MB
sudo lvreduce -L 800M /dev/my_vg/my_lv    # Shrink LV to 800MB
sudo mount /dev/my_vg/my_lv /mnt/lvm_data

# Practice Task 9:
# 1. Extend your 'home_lv' by 200MB
# 2. Resize the file system to use the new space
# 3. Verify the new size with 'df -h'
```

**LVM Snapshots:**

```bash
# Create snapshot (requires free space in VG)
sudo lvcreate -L 100M -s -n home_snapshot /dev/my_vg/home_lv

# Mount snapshot (read-only usually)
sudo mkdir /mnt/snapshot
sudo mount /dev/my_vg/home_snapshot /mnt/snapshot

# Restore from snapshot
sudo umount /dev/my_vg/home_lv
sudo lvconvert --merge /dev/my_vg/home_snapshot

# Practice Task 10:
# 1. Create a snapshot of your 'home_lv'
# 2. Add some files to the original volume
# 3. Mount the snapshot and verify it shows the original state
# 4. Practice merging the snapshot (be careful!)
```

**Advanced LVM Features:**

```bash
# Striping (improve performance)
sudo lvcreate -L 1G -i 2 -I 64 -n striped_lv my_vg
# -i 2: use 2 physical volumes
# -I 64: stripe size 64KB

# Mirroring (redundancy)
sudo lvcreate -L 1G -m 1 -n mirrored_lv my_vg
# -m 1: one mirror copy

# Thin provisioning (over-commitment)
sudo lvcreate -L 100G --thinpool my_thin_pool my_vg
sudo lvcreate -V 50G --thin -n thin_vol my_vg/my_thin_pool

# Practice Task 11:
# 1. Create a striped logical volume across two physical volumes
# 2. Test the performance with 'dd if=/dev/zero of=/mnt/striped/test bs=1M count=100'
# 3. Compare with a regular logical volume
```

**LVM Monitoring and Maintenance:**

```bash
# Monitor LVM status
sudo pvscan
sudo vgscan
sudo lvscan

# Check for errors
sudo lvmdump                     # Collect LVM information for debugging

# Backup LVM configuration
sudo vgcfgbackup                 # Backup volume group configuration

# Practice Task 12:
# 1. Create a script that monitors LVM health and free space
# 2. Set up regular LVM configuration backups
# 3. Create an alert system for low space in volume groups
```

**Best Practices:**
* Always keep some free space in volume groups for snapshots and extensions
* Use descriptive names for volume groups and logical volumes
* Monitor thin pools carefully to avoid over-commitment issues
* Test snapshot and recovery procedures regularly
* Document your LVM layout and backup procedures

---

## **Homework Assignment: Storage Management**

**Instructions:** Complete all tasks and document your work in `~/homework_storage/`. Create comprehensive documentation of your storage setup.

**Tasks:**

1. **Disk Partitioning Mastery (30 points)**
   Create a script `partition_setup.sh` that:
   - Creates a GPT partition table on a practice disk
   - Creates three partitions: 500MB (EFI), 1GB (swap), and the rest (Linux)
   - Formats partitions appropriately (FAT32 for EFI, swap, ext4 for Linux)
   - Sets up the swap partition and enables it
   - Configures automatic mounting in /etc/fstab

2. **LVM Storage System (40 points)**
   Build a complete LVM system that:
   - Creates physical volumes from two practice disks
   - Creates a volume group spanning both disks
   - Creates three logical volumes:
     * 2GB for /opt/applications
     * 1GB for /var/log
     * Remaining space for /home/data
   - Implements file systems (ext4) and automatic mounting
   - Demonstrates extending a logical volume when needed

3. **Advanced LVM Operations (20 points)**
   Create a script `lvm_operations.sh` that:
   - Takes snapshots of critical logical volumes
   - Demonstrates volume extension with file system growth
   - Shows safe volume reduction procedure
   - Includes backup and restore functionality for LVM metadata

4. **Storage Monitoring System (10 points)**
   Develop a monitoring script that:
   - Checks disk health (SMART status if available)
   - Monitors file system usage and inodes
   - Tracks LVM volume group free space
   - Sends alerts when thresholds are exceeded
   - Generates daily storage reports

**Example Starter for partition_setup.sh:**
```bash
#!/bin/bash

DISK="/dev/sdb"

echo "=== Disk Partitioning Setup ==="

# Create GPT partition table
echo "Creating GPT partition table on $DISK"
sudo parted $DISK mklabel gpt

# Create partitions
echo "Creating partitions..."
sudo parted -a opt $DISK mkpart primary fat32 1MiB 501MiB
sudo parted $DISK set 1 esp on  # Set EFI System Partition flag

sudo parted -a opt $DISK mkpart primary linux-swap 501MiB 1501MiB
sudo parted -a opt $DISK mkpart primary ext4 1501MiB 100%

# Format partitions
echo "Formatting partitions..."
sudo mkfs.fat -F32 ${DISK}1
sudo mkswap ${DISK}2
sudo mkfs.ext4 ${DISK}3

# Enable swap
echo "Enabling swap..."
sudo swapon ${DISK}2

echo "Partitioning complete!"
```

**Example lvm_operations.sh structure:**
```bash
#!/bin/bash

VG_NAME="student_vg"
LV_BACKUP="/opt/backups"

create_snapshot() {
    local lv_name=$1
    local snapshot_size=$2
    
    echo "Creating snapshot of $lv_name"
    sudo lvcreate -L ${snapshot_size} -s -n ${lv_name}_snapshot /dev/${VG_NAME}/${lv_name}
}

extend_volume() {
    local lv_name=$1
    local additional_space=$2
    
    echo "Extending $lv_name by $additional_space"
    sudo lvextend -L +${additional_space} /dev/${VG_NAME}/${lv_name}
    sudo resize2fs /dev/${VG_NAME}/${lv_name}
}

backup_lvm_config() {
    echo "Backing up LVM configuration..."
    sudo vgcfgbackup -f ${LV_BACKUP}/lvm_backup_$(date +%Y%m%d).conf
}
```

**Submission Requirements:**
- All scripts in `~/homework_storage/`
- Screenshots or output showing your working LVM setup
- Documentation of your partitioning scheme and LVM layout
- Output from monitoring scripts
- A recovery plan for disk failure scenarios

**Bonus Challenge:**
Set up a software RAID (mdadm) array and then use LVM on top of it for combined redundancy and flexibility. Document the performance characteristics and failure recovery process.

This homework will give students hands-on experience with both traditional partitioning and modern LVM storage management - essential skills for enterprise Linux administration!

[Main](../README.md)
---