[Main](../README.md)
---

# **Lesson 2: Advanced Terraform Usage & Best Practices**

## **Terraform State Management**

**Useful Information:**
* **Remote State:** Store state file in shared location (S3, GCS, Terraform Cloud)
* **State Locking:** Prevent concurrent modifications
* **State Security:** Protect sensitive data in state files
* **Backends:** Configure where state is stored

### **Remote State with Terraform Cloud**

Create `backend.tf`:
```hcl
terraform {
  backend "remote" {
    organization = "your-organization-name"

    workspaces {
      name = "student-${var.student_id}"
    }
  }
}
```

**Practice Task 1:**
1. Create a free Terraform Cloud account
2. Create an organization and workspace
3. Configure remote backend
4. Run `terraform init` to migrate state to Terraform Cloud

### **Alternative: S3-style Backend (Hetzner Spaces)**

```hcl
# If using Hetzner Spaces (S3-compatible) for remote state
terraform {
  backend "s3" {
    endpoint = "https://your-region.digitaloceanspaces.com"
    bucket   = "terraform-state-${var.student_id}"
    key      = "terraform.tfstate"
    region   = "us-east-1"  # Required but ignored for Spaces

    skip_credentials_validation = true
    skip_region_validation      = true
    skip_metadata_api_check     = true
  }
}
```

---

## **Module Development and Usage**

### **Creating Your First Module**

Create `modules/server/main.tf`:
```hcl
# Server module for creating Hetzner servers with consistent configuration

variable "name" {
  description = "Base name for resources"
  type        = string
}

variable "environment" {
  description = "Environment (dev, staging, prod)"
  type        = string
  default     = "dev"
}

variable "server_type" {
  description = "Hetzner server type"
  type        = string
  default     = "cx11"
}

variable "ssh_key_id" {
  description = "SSH key ID for server access"
  type        = string
}

variable "firewall_id" {
  description = "Firewall ID to attach"
  type        = string
}

variable "user_data" {
  description = "Cloud-init user data"
  type        = string
  default     = ""
}

locals {
  resource_name = "${var.name}-${var.environment}"
  common_tags = {
    Environment = var.environment
    ManagedBy   = "terraform"
    Module      = "server"
  }
}

resource "hcloud_server" "main" {
  name        = local.resource_name
  image       = "ubuntu-22.04"
  server_type = var.server_type
  datacenter  = "fsn1-dc14"
  ssh_keys    = [var.ssh_key_id]
  user_data   = var.user_data
  labels      = local.common_tags

  firewall_ids = [var.firewall_id]
}

output "server_id" {
  description = "ID of the created server"
  value       = hcloud_server.main.id
}

output "server_ip" {
  description = "Public IP address of the server"
  value       = hcloud_server.main.ipv4_address
}

output "server_name" {
  description = "Name of the server"
  value       = hcloud_server.main.name
}
```

Create `modules/server/outputs.tf`:
```hcl
output "server_details" {
  description = "All server details"
  value       = hcloud_server.main
}
```

Create `modules/server/variables.tf`:
```hcl
# (Variable definitions from above)
```

### **Using the Module**

Create `main.tf` in root:
```hcl
# Using the server module
module "web_server" {
  source      = "./modules/server"
  name        = "${var.project_name}-web"
  environment = var.environment
  server_type = var.server_size
  ssh_key_id  = hcloud_ssh_key.student_ssh_key.id
  firewall_id = hcloud_firewall.student_firewall.id
  
  user_data = templatefile("${path.module}/templates/cloud-init.yaml", {
    student_id  = var.student_id
    server_role = "web"
  })
}

module "database_server" {
  source      = "./modules/server"
  name        = "${var.project_name}-db"
  environment = var.environment
  server_type = "cx21"  # Larger for database
  ssh_key_id  = hcloud_ssh_key.student_ssh_key.id
  firewall_id = hcloud_firewall.student_firewall.id
  
  user_data = templatefile("${path.module}/templates/cloud-init.yaml", {
    student_id  = var.student_id
    server_role = "database"
  })
}
```

**Practice Task 3:**
1. Create the server module with the structure above
2. Use the module to create multiple servers
3. Run `terraform init` to initialize the module
4. Deploy the infrastructure and verify module outputs

---

## **Data Sources and Dependency Management**

### **Using Data Sources**

Create `data_sources.tf`:
```hcl
# Get available server images
data "hcloud_image" "ubuntu" {
  name              = "ubuntu-22.04"
  with_architecture = "x86"
  most_recent       = true
}

# Get SSH key by name (if it exists)
data "hcloud_ssh_key" "existing" {
  name  = var.existing_ssh_key_name
}

# Get information about available server types
data "hcloud_server_type" "selected" {
  name = var.server_size
}

# Get all available datacenters
data "hcloud_datacenters" "all" {}

# Get specific datacenter information
data "hcloud_datacenter" "selected" {
  name = var.datacenter
}
```

**Practice Task 5:**
1. Add data sources to get information about available resources
2. Implement explicit dependencies between resources
3. Use data sources to make your configuration more dynamic
4. Test dependency ordering

---

## **Terraform Best Practices**

### **File and Directory Structure**

```
terraform-advanced/
├── main.tf                 # Primary resources
├── variables.tf            # Variable definitions
├── outputs.tf              # Output values
├── terraform.tfvars        # Variable values
├── providers.tf            # Provider configuration
├── backend.tf              # Backend configuration
├── locals.tf               # Local values
├── data_sources.tf         # Data sources
├── versions.tf             # Version constraints
│
├── modules/
│   ├── server/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── README.md
│   └── network/
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── README.md
│
├── environments/
│   ├── dev/
│   │   ├── terraform.tfvars
│   │   └── backend.tfvars
│   ├── staging/
│   │   ├── terraform.tfvars
│   │   └── backend.tfvars
│   └── prod/
│       ├── terraform.tfvars
│       └── backend.tfvars
│
└── templates/
    ├── cloud-init.yaml
    └── user-data.sh
```

### **Version Constraints and Pinpointing**

Create `versions.tf`:
```hcl
terraform {
  required_version = ">= 1.0, < 2.0.0"

  required_providers {
    hcloud = {
      source  = "hetznercloud/hcloud"
      version = "~> 1.45.0"  # Pin to specific version
    }

    # Additional providers
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5.0"
    }

    template = {
      source  = "hashicorp/template"
      version = "~> 2.2.0"
    }

    local = {
      source  = "hashicorp/local"
      version = "~> 2.4.0"
    }
  }
}
```

### **Security Best Practices**

Create `security.tf`:
```hcl
# Sensitive variables
variable "hcloud_token" {
  description = "Hetzner Cloud API Token"
  type        = string
  sensitive   = true
}

# Sensitive outputs
output "database_password" {
  description = "Database administrator password"
  value       = random_password.db_password.result
  sensitive   = true
}

# Secure random resources
resource "random_password" "db_password" {
  length           = 16
  special          = true
  override_special = "!#$%&*()-_=+[]{}<>:?"
}

# Secure storage of sensitive data
resource "local_sensitive_file" "credentials" {
  content  = "API_KEY=${var.hcloud_token}"
  filename = "${path.module}/.env"
  file_permission = "0600"
}
```

**Practice Task 7:**
1. Reorganize your code following the best practices structure
2. Add version constraints for Terraform and providers
3. Implement sensitive variable handling
4. Use random resources for secure value generation

---

## **Advanced Provisioning and Templates**

### **Cloud-Init Templates**

Create `templates/cloud-init.yaml`:
```yaml
#cloud-config
package_update: true
package_upgrade: true

users:
  - name: ${username}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_key}

packages:
  - nginx
  - curl
  - git
  - htop

write_files:
  - path: /etc/motd
    content: |
      Welcome to ${server_name}
      Managed by Terraform
      Student: ${student_id}
      Role: ${server_role}

runcmd:
  - systemctl enable nginx
  - systemctl start nginx
  - echo "Server setup complete at $(date)" >> /var/log/cloud-init-output.log
```

### **Template Usage**

```hcl
data "template_cloudinit_config" "server_config" {
  gzip          = false
  base64_encode = false

  part {
    content_type = "text/cloud-config"
    content = templatefile("${path.module}/templates/cloud-init.yaml", {
      username   = "admin"
      ssh_key    = tls_private_key.student_key.public_key_openssh
      server_name = var.server_name
      student_id  = var.student_id
      server_role = var.server_role
    })
  }
}

resource "hcloud_server" "configured_server" {
  # ... other configuration ...
  user_data = data.template_cloudinit_config.server_config.rendered
}
```

**Practice Task 8:**
1. Create cloud-init templates for different server roles
2. Use templatefile function to render configurations
3. Implement different provisioning scripts for web, database, and app servers
4. Verify provisioning works by checking installed packages and services

---

## **Homework Assignment: Advanced Terraform Project**

**Instructions:** Create a complete, production-ready infrastructure using all advanced concepts covered.

**Tasks:**

1. **Modular Infrastructure (30 points)**
   Create a modular infrastructure with:
   - Server module (supports multiple instances)
   - Network module (VPC, subnets, firewalls)
   - Load balancer module (conditional creation)
   - Database module (with backups and replication)

2. **Environment Management (25 points)**
   Implement multi-environment deployment:
   - Development (1 server, no backups)
   - Staging (2 servers, with backups) 
   - Production (3 servers, high availability)
   - Use workspaces and environment-specific variables

3. **Advanced Configuration (25 points)**
   Implement:
   - Complex variable validation
   - Dynamic blocks for flexible configuration
   - Data sources for existing resources
   - Template files for user data
   - Secure handling of sensitive data

4. **Production Best Practices (20 points)**
   Demonstrate:
   - Remote state management
   - Proper file structure
   - Version pinning
   - Resource tagging and naming conventions
   - Documentation and README

**Example Production Configuration:**

Create `environments/prod/main.tf`:
```hcl
module "network" {
  source = "../../modules/network"
  
  name        = "${var.project_name}-prod"
  environment = "production"
  cidr_block  = "10.3.0.0/16"
}

module "web_servers" {
  source = "../../modules/server"
  
  for_each = { for i in range(3) : i => i }
  
  name        = "${var.project_name}-web-${each.value}"
  environment = "production"
  server_type = "cx21"
  ssh_key_id  = module.base.ssh_key_id
  firewall_id = module.network.web_firewall_id
  network_id  = module.network.network_id
  
  user_data = templatefile("../../templates/web-server.yaml", {
    student_id  = var.student_id
    server_role = "web"
    server_id   = each.value
  })
}

module "load_balancer" {
  source = "../../modules/load_balancer"
  
  enabled    = true
  name       = "${var.project_name}-lb"
  server_ips = [for server in module.web_servers : server.server_ip]
}
```

**Submission Requirements:**
- Complete Terraform code following best practices
- Documentation in README.md
- Screenshots of deployed infrastructure
- Terraform plan output for each environment
- Evidence of remote state configuration

**Bonus Challenge:**
Implement a CI/CD pipeline using GitHub Actions that:
- Automatically runs terraform validate on PRs
- Plans changes on push to main
- Applies changes to staging automatically
- Requires manual approval for production

This advanced lesson will prepare you for real-world Terraform usage in professional environments!

[Main](../README.md)
---