[Main](../README.md)
---

### What is Variable Registration?

**Definition**: The `register` keyword in Ansible captures the output of a task and stores it in a variable for later use. This allows you to make decisions based on previous task results, create dynamic configurations, and handle errors gracefully.

### Register Output Structure

When you register a variable, it contains a rich structure with multiple attributes:

```yaml
- name: Example task
  command: echo "hello world"
  register: result

# result contains:
# {
#   "changed": true/false,
#   "cmd": ["echo", "hello world"],
#   "delta": "0:00:00.001529",
#   "end": "2023-10-05 10:30:45.123456",
#   "failed": false,
#   "rc": 0,
#   "start": "2023-10-05 10:30:45.121927",
#   "stderr": "",
#   "stderr_lines": [],
#   "stdout": "hello world",
#   "stdout_lines": ["hello world"]
# }
```

### Common Registered Variable Attributes

| Attribute | Description | Common Use Cases |
|-----------|-------------|------------------|
| `stdout` | Standard output as string | `result.stdout == "expected"` |
| `stdout_lines` | Standard output as list | `item in result.stdout_lines` |
| `stderr` | Standard error as string | `result.stderr != ""` |
| `stderr_lines` | Standard error as list | `len(result.stderr_lines) > 0` |
| `rc` | Return code | `result.rc == 0` |
| `failed` | Task failed | `result.failed` |
| `changed` | Task made changes | `result.changed` |
| `cmd` | Command executed | `result.cmd | join(' ')` |
| `msg` | Module-specific message | `result.msg` |


### Module-Specific Registered Data

Different modules return different data structures:

#### Command/Shell Modules
```yaml
- name: Run command
  command: ls -la /tmp
  register: cmd_result
# Uses: cmd_result.stdout, cmd_result.rc
```

#### File/Stat Modules
```yaml
- name: Check file status
  stat:
    path: /etc/hosts
  register: file_stat
# Uses: file_stat.stat.exists, file_stat.stat.mtime
```

#### Service Modules
```yaml
- name: Check service status
  systemd:
    name: nginx
    state: started
  register: service_status
# Uses: service_status.status, service_status.changed
```

#### Package Modules
```yaml
- name: Install package
  apt:
    name: nginx
    state: present
  register: pkg_result
# Uses: pkg_result.changed, pkg_result.rc
```

### Registration Cheat-Sheet

#### Basic Registration Patterns
```yaml
# Capture command output
- command: "echo 'test'"
  register: cmd_output

# Check file existence
- stat:
    path: "/path/to/file"
  register: file_check

# Get service status
- systemd:
    name: "nginx"
  register: service_info

# Install package and check result
- package:
    name: "nginx"
    state: present
  register: install_result
```

#### Common Result Checks
```yaml
# Check if command succeeded
when: cmd_result.rc == 0

# Check if output contains text
when: "'success' in cmd_result.stdout"

# Check if file exists
when: file_stat.stat.exists

# Check if service is running
when: service_info.status.ActiveState == "active"

# Check if package was installed
when: install_result.changed
```

### Major Facts Categories

#### System Information Facts
| Fact | Description | Example |
|------|-------------|---------|
| `ansible_distribution` | OS distribution | `Ubuntu`, `CentOS` |
| `ansible_distribution_version` | OS version | `20.04`, `7.9` |
| `ansible_os_family` | OS family | `Debian`, `RedHat` |
| `ansible_kernel` | Kernel version | `5.4.0-42-generic` |
| `ansible_architecture` | System architecture | `x86_64`, `aarch64` |
| `ansible_userspace_bits` | Architecture bits | `64`, `32` |
| `ansible_date_time` | Date/time information | Various datetime fields |

#### Hardware Facts
| Fact | Description | Example |
|------|-------------|---------|
| `ansible_processor_count` | Number of processors | `1` |
| `ansible_processor_cores` | Total cores | `4` |
| `ansible_processor_vcpus` | Total vCPUs | `8` |
| `ansible_memtotal_mb` | Total memory (MB) | `7982` |
| `ansible_memfree_mb` | Free memory (MB) | `512` |
| `ansible_swaptotal_mb` | Total swap (MB) | `2048` |
| `ansible_devices` | Storage devices | Dictionary of devices |
| `ansible_mounts` | Mount points | List of mount information |

#### Network Facts
| Fact | Description | Example |
|------|-------------|---------|
| `ansible_default_ipv4` | Primary IPv4 | `{address: 192.168.1.10}` |
| `ansible_default_ipv6` | Primary IPv6 | `{address: fe80::...}` |
| `ansible_all_ipv4_addresses` | All IPv4 addresses | `[192.168.1.10, 10.0.0.1]` |
| `ansible_all_ipv6_addresses` | All IPv6 addresses | `[fe80::...]` |
| `ansible_interfaces` | Network interfaces | `[eth0, lo, wlan0]` |
| `ansible_<interface>` | Interface details | `ansible_eth0` |

#### Virtualization Facts
| Fact | Description | Example |
|------|-------------|---------|
| `ansible_virtualization_type` | Virtualization type | `kvm`, `xen`, `docker` |
| `ansible_virtualization_role` | Role in virtualization | `guest`, `host` |
| `ansible_virtualization_tech_guest` | Guest technologies | `[docker, kvm]` |
| `ansible_virtualization_tech_host` | Host technologies | `[kvm]` |

### Facts Cheat-Sheet

#### Common Conditional Patterns
```yaml
# OS-specific conditions
when: ansible_os_family == "Debian"
when: ansible_distribution == "Ubuntu"
when: ansible_distribution_version == "20.04"

# Hardware-based conditions
when: ansible_memtotal_mb > 4096
when: ansible_processor_cores >= 4
when: ansible_architecture == "x86_64"

# Network-based conditions
when: ansible_default_ipv4.address == "192.168.1.10"
when: "'eth0' in ansible_interfaces"

# Virtualization conditions
when: ansible_virtualization_type == "docker"
when: ansible_virtualization_role == "guest"
```

### What are Conditionals?

**Definition**: Conditionals in Ansible allow you to control whether tasks run based on specific conditions. The `when` statement is the primary way to implement conditional execution in playbooks.

### Basic Conditional Syntax

```yaml
- name: Task name
  module:
    parameter: value
  when: condition
```

### Conditional Types and Operators

#### Comparison Operators
| Operator | Description | Example |
|----------|-------------|---------|
| `==` | Equal to | `ansible_os_family == "Debian"` |
| `!=` | Not equal to | `ansible_distribution != "Ubuntu"` |
| `>` | Greater than | `ansible_memtotal_mb > 4096` |
| `<` | Less than | `ansible_processor_cores < 4` |
| `>=` | Greater than or equal | `ansible_memfree_mb >= 1024` |
| `<=` | Less than or equal | `ansible_architecture == "x86_64"` |

#### Logical Operators
| Operator | Description | Example |
|----------|-------------|---------|
| `and` | Both conditions true | `condition1 and condition2` |
| `or` | Either condition true | `condition1 or condition2` |
| `not` | Negate condition | `not condition` |
| `()` | Group conditions | `(condition1 or condition2) and condition3` |

#### Membership Operators
| Operator | Description | Example |
|----------|-------------|---------|
| `in` | Value in list | `"nginx" in ansible_facts.packages` |
| `not in` | Value not in list | `"apache" not in group_names` |

### Common Conditional Variables Cheat-Sheet

#### System Facts
| Variable | Description | Example Condition |
|----------|-------------|-------------------|
| `ansible_os_family` | OS family | `ansible_os_family == "RedHat"` |
| `ansible_distribution` | Distribution name | `ansible_distribution == "Ubuntu"` |
| `ansible_distribution_version` | Version | `ansible_distribution_version == "20.04"` |
| `ansible_architecture` | CPU architecture | `ansible_architecture == "x86_64"` |
| `ansible_memtotal_mb` | Total memory | `ansible_memtotal_mb > 2048` |
| `ansible_processor_cores` | CPU cores | `ansible_processor_cores >= 2` |
| `ansible_default_ipv4.address` | IP address | `ansible_default_ipv4.address == "192.168.1.10"` |

#### Inventory and Groups
| Variable | Description | Example Condition |
|----------|-------------|-------------------|
| `inventory_hostname` | Current hostname | `inventory_hostname == "web1"` |
| `group_names` | List of groups host belongs to | `"webservers" in group_names` |
| `groups` | All groups in inventory | `"db-master" in groups.databases` |

#### Task Execution
| Variable | Description | Example Condition |
|----------|-------------|-------------------|
| `ansible_check_mode` | Running in check mode | `not ansible_check_mode` |
| `ansible_diff_mode` | Running in diff mode | `ansible_diff_mode` |
| `changed_when` | Custom changed condition | `result.rc == 0` |
| `failed_when` | Custom failure condition | `"ERROR" in result.stdout` |

### Evolution of Loops in Ansible

- **Traditional**: `with_*` lookups (Ansible 2.4 and earlier)
- **Modern**: `loop` keyword (Ansible 2.5+)
- **Current**: `loop` is recommended, `with_*` deprecated but still supported

### Loop Types and Syntax

#### Basic Loop Structure
```yaml
- name: Task with loop
  module:
    parameter: "{{ item }}"
  loop:
    - value1
    - value2
    - value3
```

#### Loop Control Directives
| Directive | Purpose | Example |
|-----------|---------|---------|
| `loop` | Main loop keyword | `loop: [1, 2, 3]` |
| `loop_control` | Control loop behavior | `loop_control: extended: true` |
| `label` | Custom item display | `label: "{{ item.name }}"` |
| `pause` | Delay between iterations | `pause: 5` |

### Loop Methods Cheat-Sheet

#### Simple List Loops
```yaml
# Basic list
loop: ['apple', 'banana', 'orange']

# Number range
loop: "{{ range(1, 5) }}"

# Variable list
loop: "{{ packages }}"
```

#### Dictionary Loops
```yaml
# List of dictionaries
loop:
  - { name: 'user1', group: 'admin' }
  - { name: 'user2', group: 'users' }

# Access with item.key
- name: Create users
  user:
    name: "{{ item.name }}"
    groups: "{{ item.group }}"
  loop:
    - { name: 'alice', group: 'wheel' }
    - { name: 'bob', group: 'users' }
```

### Loop Control Options

#### loop_control Parameters
```yaml
loop_control:
  pause: 3                           # Seconds between iterations
  index_var: my_index                # Custom index variable name
  loop_var: my_fruit
  break_when:
          - password is match(password_policy)
```

### Traditional with_* Lookups (Legacy)

| Lookup | Purpose | Modern Equivalent |
|--------|---------|-------------------|
| `with_items` | Simple list | `loop` |
| `with_dict` | Dictionary | `loop: "{{ dict \| dict2items }}"` |
| `with_fileglob` | File patterns | `loop: "{{ query('fileglob', 'pattern') }}"` |
| `with_sequence` | Number sequence | `loop: "{{ range(start, end) }}"` |
| `with_nested` | Nested loops | `loop: "{{ list1 \| product(list2) }}"` |
| `with_subelements` | Sub-elements | `loop: "{{ list \| subelements('key') }}"` |
| `with_together` | Zip lists | `loop: "{{ list1 \| zip(list2) }}"` |

### Loop Cheat-Sheet

#### Common Loop Patterns
```yaml
# Package installation
- name: Install multiple packages
  package:
    name: "{{ item }}"
    state: present
  loop:
    - nginx
    - mysql-server
    - php-fpm

# File creation
- name: Create multiple files
  copy:
    content: "{{ item.content }}"
    dest: "{{ item.path }}"
  loop:
    - { path: '/tmp/file1.txt', content: 'Hello' }
    - { path: '/tmp/file2.txt', content: 'World' }

# User management
- name: Create multiple users
  user:
    name: "{{ item.name }}"
    groups: "{{ item.groups }}"
    state: present
  loop:
    - { name: 'alice', groups: 'sudo' }
    - { name: 'bob', groups: 'users' }
```

#### Loop with Conditionals
```yaml
- name: Install packages conditionally
  package:
    name: "{{ item }}"
    state: present
  loop:
    - nginx
    - mysql-server
  when: item != "mysql-server" or install_mysql | default(true)
```

#### Loop with Registered Variables
```yaml
- name: Check multiple services
  systemd:
    name: "{{ item }}"
    state: started
  register: service_results
  loop:
    - nginx
    - mysql
    - php-fpm

- name: Display service status
  debug:
    msg: "Service {{ item.item }}: {{ 'running' if item.status.ActiveState == 'active' else 'stopped' }}"
  loop: "{{ service_results.results }}"
```

## Error Handling Methods

| Method | Purpose | Use Case |
|--------|---------|----------|
| `ignore_errors: yes` | Continue on error | Non-critical operations |
| `failed_when` | Custom failure conditions | Conditional failure |
| `changed_when` | Custom changed conditions | Control idempotency |
| `block/rescue` | Structured error handling | Complex error recovery |
| `any_errors_fatal` | Stop play on first error | Critical deployments |

### ignore_errors Deep Dive

#### Basic Syntax
```yaml
- name: Task that might fail
  command: /bin/false
  ignore_errors: yes
```

#### When to Use ignore_errors
- **Non-critical tasks**: Operations that can fail without affecting overall success
- **Exploratory tasks**: Checking for optional features or conditions
- **Graceful degradation**: Continuing with reduced functionality
- **Cleanup operations**: Tasks that should run even if previous tasks failed

#### When NOT to Use ignore_errors
- **Critical operations**: Where failure should stop execution
- **Security-sensitive tasks**: Where failure indicates security issues
- **Dependency operations**: Where subsequent tasks depend on success

### Error Handling Cheat-Sheet

#### Basic Error Handling
```yaml
# Continue on any error
ignore_errors: yes

# Continue only on specific error codes
ignore_errors: "{{ ansible_rc != 2 }}"

# Conditional error ignoring
ignore_errors: "{{ ignore_this_error | default(false) }}"
```

# Ansible Roles and Variable Management

**Definition**: Roles are a way to automatically load related vars, files, tasks, handlers, and other Ansible artifacts based on a known file structure. They provide a framework for fully independent, reusable, and shareable collections of variables, tasks, files, templates, and modules.

### The Problem Roles Solve

**Before Roles**:
- Monolithic playbooks with hundreds of tasks
- Duplicated code across multiple playbooks
- Difficult to maintain and share functionality
- No standardization or reusability

**After Roles**:
- Modular, reusable components
- Clean separation of concerns
- Easy sharing and distribution
- Standardized structure


### What is ansible-galaxy?

**Definition**: `ansible-galaxy` is Ansible's command-line tool for creating, managing, and installing roles from Ansible Galaxy (the community hub for sharing Ansible roles) or other sources.

### ansible-galaxy Command Overview

| Command | Purpose | Example |
|---------|---------|---------|
| `ansible-galaxy role init` | Create new role structure | `ansible-galaxy role init my_role` |
| `ansible-galaxy role install` | Install roles | `ansible-galaxy role install username.role` |
| `ansible-galaxy role list` | List installed roles | `ansible-galaxy role list` |
| `ansible-galaxy role remove` | Remove roles | `ansible-galaxy role remove role_name` |
| `ansible-galaxy role import` | Import to Galaxy | `ansible-galaxy role import username repo` |


### Standard Role Directory Structure

```
role_name/
├── defaults/         # Default variables (lowest priority)
│   └── main.yml      # Default variables that users can easily override
├── files/            # Static files for copy/template
├── handlers/         # Handlers
│   └── main.yml
├── meta/             # Role metadata and dependencies
│   └── main.yml
├── README.md         # Documentation
├── tasks/            # Main task list
│   └── main.yml
├── templates/        # Jinja2 templates
├── tests/            # Test cases
│   ├── inventory
│   └── test.yml
└── vars/             # Role variables (higher priority)
    └── main.yml      # Role-specific variables that shouldn't be overridden
```

### Role Usage Patterns

#### Basic Role Inclusion
```yaml
- hosts: webservers
  roles:
    - common
    - nginx
    - app
```

#### Role with Parameters
```yaml
- hosts: webservers
  roles:
    - role: nginx
      nginx_port: 8080
      ssl_enabled: true
```

#### Conditional Role Execution
```yaml
- hosts: webservers
  roles:
    - role: nginx
      when: install_nginx | default(true)
```

#### Dynamic Role Inclusion
```yaml
- hosts: webservers
  tasks:
    - name: Include nginx role
      include_role:
        name: nginx
      vars:
        nginx_port: 8080
```

### Create role
```bash
ansible-galaxy role init common
tree roles/ || find roles/ -type f
```

### Files
defaults/main.yml
```yaml
---
# Common role default variables
common_timezone: UTC
common_locale: en_US.UTF-8

# Package management
common_packages:
  - curl
  - wget
  - htop
  - vim
  - git

# User management
common_users: []
common_admin_users:
  - ansible

# Security settings
common_firewall_ports:
  - 22   # SSH
  - 80   # HTTP
  - 443  # HTTPS

# System settings
common_ssh_permit_root_login: no
common_ssh_password_authentication: no
```

vars/main.yml
```yaml
---
# OS-specific package names
common_package_manager: "{{ 'apt' if ansible_os_family == 'Debian' else 'yum' }}"

# Service management
common_service_manager: "{{ 'systemd' if ansible_service_mgr == 'systemd' else 'sysvinit' }}"
```

tasks/main.yml
```yaml
---
- name: Include OS-specific variables
  include_vars: "{{ ansible_os_family }}.yml"
  ignore_errors: yes

- name: Install common packages
  package:
    name: "{{ item }}"
    state: present
  loop: "{{ common_packages }}"
  tags: ['packages', 'common']

- name: Configure timezone
  timezone:
    name: "{{ common_timezone }}"
  tags: ['configuration', 'common']

- name: Configure locale
  locale_gen:
    name: "{{ common_locale }}"
    state: present
  when: ansible_os_family == "Debian"
  tags: ['configuration', 'common']

- name: Create admin users
  user:
    name: "{{ item }}"
    groups: sudo
    shell: /bin/bash
    state: present
  loop: "{{ common_admin_users }}"
  tags: ['users', 'common']

- name: Configure SSH security
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^{{ item.key }}"
    line: "{{ item.key }} {{ item.value }}"
    state: present
    backup: yes
  loop:
    - { key: "PermitRootLogin", value: "{{ common_ssh_permit_root_login | default('no') }}" }
    - { key: "PasswordAuthentication", value: "{{ common_ssh_password_authentication | default('no') }}" }
  notify: restart ssh
  tags: ['security', 'ssh', 'common']
```

```bash
# Create OS-specific variables
mkdir -p vars/
cat > vars/Debian.yml << 'EOF'
---
common_packages:
  - curl
  - wget
  - htop
  - vim
  - git
  - ufw
  - fail2ban
EOF

cat > vars/RedHat.yml << 'EOF'
---
common_packages:
  - curl
  - wget
  - htop
  - vim-enhanced
  - git
  - firewalld
  - fail2ban
EOF
```

handlers/main.yml
```yaml
---
- name: restart ssh
  service:
    name: ssh
    state: restarted

- name: reload ssh
  service:
    name: ssh
    state: reloaded
```

### Managing Variables & Precedence
```yaml
# roles/webapp/vars/main.yml
app_name: "role_var_app"
max_connections: 100
```

4. Create playbook:
```yaml
# playbook.yml
- hosts: localhost
  connection: local
  vars:
    app_port: 9000
    debug: true
  roles:
    - role: webapp
      vars:
        app_name: "playbook_role_var_app"
```

5. Create group variables:
```yaml
# group_vars/all.yml
database_host: "db-server.example.com"
```

6. Create role tasks:
```yaml
# roles/webapp/tasks/main.yml
- name: Display all variables
  debug:
    msg: |
      app_port: {{ app_port }}
      app_name: {{ app_name }}
      debug: {{ debug }}
      database_host: {{ database_host }}
      max_connections: {{ max_connections }}
```
7. Run and observe:
```bash
ansible-playbook playbook.yml
# Observe which values take precedence
```

### Task 2: Command Line Overrides
```bash
# Override specific variables
ansible-playbook playbook.yml --extra-vars "app_port=3000 debug=false"

# Use JSON for complex overrides
ansible-playbook playbook.yml --extra-vars '{"app_port": 4000, "app_name": "cmd_app"}'
```

## Best Practices

> rolename_variablename
> variable
> _variable - setfact
> __variable - register

**Define Default Variables**
```yaml
# roles/nginx/defaults/main.yml
---
# Nginx package and service
nginx_package: nginx
nginx_service: nginx
nginx_user: nginx

# Nginx configuration
nginx_worker_processes: "{{ ansible_processor_cores }}"
nginx_worker_connections: 1024
nginx_listen_port: 80
nginx_keepalive_timeout: 65

# Virtual hosts
nginx_vhosts: []
  # - name: example.com
  #   port: 80
  #   document_root: /var/www/example
  #   ssl: false
  #   ssl_cert: null
  #   ssl_key: null

# Security
nginx_disable_default_site: true
nginx_server_tokens: off
```

**Create Modular Tasks**
```yaml
# roles/nginx/tasks/main.yml
---
- name: Include OS-specific variables
  include_vars: "{{ ansible_os_family }}.yml"
  when: ansible_os_family in ['RedHat', 'Debian']

- name: Include installation tasks
  include_tasks: install.yml
```

### Default variables overwriting chain
```yaml
- name: Create and configure AWX projects
  awx.awx.project:
    name: "{{ item.name }}"
    new_name: "{{ item.new_name | default(omit) }}"
    description: "{{ item.description | default(awx_resources_projects_description | default(omit)) }}"
    organization: "{{ item.organization | default(awx_resources_projects_organization | default(omit)) }}"
```

[Main](../README.md)
---