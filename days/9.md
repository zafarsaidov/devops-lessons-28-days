[Main](../README.md)
---

## **Lesson 1: Terraform Fundamentals & Core Concepts**

### **Introduction to Infrastructure as Code (IaC)**

**Useful Information:**
* **Terraform:** Infrastructure as Code tool by HashiCorp for building, changing, and versioning infrastructure
* **Hetzner Cloud:** German cloud provider with excellent pricing and performance
* **Key Benefits:**
  - Repeatable infrastructure deployments
  - Version control for infrastructure
  - Collaboration and code review
  - Documentation through code

**Core Concepts:**
* **Providers:** Plugins that interact with APIs (Hetzner, AWS, Azure, etc.)
* **Resources:** Infrastructure components (servers, networks, volumes)
* **State:** Tracks current state of managed infrastructure
* **Configuration:** Code that describes desired infrastructure state

---

### **Setup and Installation**

**Prerequisites Setup:**

```bash
# Install Terraform (on Ubuntu)
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform

# Verify installation
terraform version

# Install Hetzner CLI (optional but helpful)
curl -s https://api.hetzner.cloud/cli/install.sh | sudo bash

# Practice Task 1:
# 1. Install Terraform on your system
# 2. Verify the installation with 'terraform version'
# 3. Create a project directory 'terraform-basics'
```

**Hetzner Cloud Setup:**

1. Create Hetzner Cloud account at https://console.hetzner.cloud
2. Create a new project called "Terraform Training"
3. Generate an API token:
   - Go to Security → API Tokens
   - Create new token with Read & Write permissions
   - Copy the token securely

```bash
# Set environment variable for authentication
export HCLOUD_TOKEN='your-api-token-here'

# Verify token works (if hetzner-cli installed)
hcloud context create terraform-training --token $HCLOUD_TOKEN

# Practice Task 2:
# 1. Create your Hetzner Cloud account and project
# 2. Generate an API token with Read & Write permissions
# 3. Set the HCLOUD_TOKEN environment variable
# 4. Verify access by listing servers: 'hcloud server list'
```

---

### **Terraform Configuration Basics**

**Basic Directory Structure:**

```bash
mkdir terraform-basics
cd terraform-basics
mkdir -p environments/prod modules/server
```

**First Terraform Configuration:**

Create `main.tf`
```hcl
resource "local_file" "file" {
  content         = "Hello World"
  filename        = "hi.txt"
  file_permission = "0600"
}
```

Run commands:
```bash
terraform init
terraform plan
terraform apply
```

Check created file and tfstate. Run command
```bash 
terraform destroy
```

Create `variables.tf`
```hcl
variable "file_name" {
  description = "File name"
  type  = string
}

variable "file_content" {
  description = "File content (password)"
  type  = string
  sensitive   = true
}
```

main.tf
```hcl 
resource "local_file" "file" {
  content         = "Hello World\n${var.file_content}\n"
  filename        = var.file_name
  file_permission = "0600"
}
```

Run commands 
```bash
terraform fmt
terraform plan
terraform apply
```
#### Pay attention output of content file (sensitive data)

Assigning Values: Values can be assigned to variables in several ways, with a defined precedence:
- Command-line arguments: Using -var or -var-file flags with terraform plan or terraform apply.
- Environment variables: Prefixing the variable name with TF_VAR_.
- .tfvars files: Providing a file containing variable assignments (e.g., terraform.tfvars, production.tfvars).
- Default values: As defined in the variable block.

Update `variables.tf`
```hcl
variable "file_name" {
  description = "File name"
  type        = string
  default = "some.txt"
}

variable "file_content" {
  description = "File content (password)"
  type        = string
  sensitive   = true
  default = "Secret data"
}
```

Run commands 
```bash
terraform fmt
terraform plan
terraform apply
```

#### Pay attention to rerlacement and prompt for value of variables

Create ENV variable and run command
```bash
export TF_VAR_file_name=env.txt
terraform plan
terraform apply
```

Create `terraform.tfvars`
```hcl
file_name = "vars.txt"
file_content = "Content from tfvars"
```

Run commands 
```bash
terraform plan
terraform apply
```

Run command
```bash
terraform apply -var file_name='cmd.txt'
```

Create `providers.tf`:
```hcl
# Configure the Hetzner Cloud Provider
terraform {
  required_providers {
    hcloud = {
      source  = "hetznercloud/hcloud"
      version = "~> 1.45"
    }
  }

  required_version = ">= 1.0"
}

provider "hcloud" {
  token = var.hcloud_token
}
```

Create `variables.tf`:
```hcl
variable "hcloud_token" {
  description = "Hetzner Cloud API Token"
  type        = string
  sensitive   = true
}
```

Create `terraform.tfvars`:
```hcl
# hcloud_token = "your-token-here"
```

**Practice Task 3:**
1. Create the basic directory structure
2. Create the four Terraform files above
3. Replace `student1` with your assigned student ID
4. Understand what each block in the configuration does

---

### **Your First Infrastructure**

**SSH Key Resource:**

Create `ssh-key.tf`:
```hcl
# Generate SSH key pair for server access
resource "tls_private_key" "student_key" {
  algorithm = "RSA"
  rsa_bits  = 4096
}

# Upload SSH public key to Hetzner Cloud
resource "hcloud_ssh_key" "student_ssh_key" {
  name       = "${var.project_name}-${var.student_id}"
  public_key = tls_private_key.student_key.public_key_openssh
}

# Save private key to file (for demonstration - be careful in production!)
resource "local_file" "private_key" {
  content         = tls_private_key.student_key.private_key_pem
  filename        = "${path.module}/${var.student_id}-key.pem"
  file_permission = "0600"
}
```

**Practice Task 4:**
1. Add the SSH key configuration to your project
2. Run `terraform init` to initialize the project
3. Run `terraform plan` to see what will be created
4. Understand the three resources being created

**First Server Resource:**

Create `server.tf`:
```hcl
# Create a basic cloud server
resource "hcloud_server" "student_server" {
  name        = "${var.project_name}-${var.student_id}"
  image       = "ubuntu-22.04"
  server_type = "cx11"  # 1 vCPU, 2GB RAM
  datacenter  = "fsn1-dc14"  # Falkenstein, Germany
  ssh_keys    = [hcloud_ssh_key.student_ssh_key.id]

  # Connection block for provisioners (we'll use this later)
  connection {
    type        = "ssh"
    user        = "root"
    private_key = tls_private_key.student_key.private_key_pem
    host        = self.ipv4_address
    timeout     = "2m"
  }

  # Basic provisioning - update system
  provisioner "remote-exec" {
    inline = [
      "apt-get update",
      "apt-get upgrade -y",
      "echo 'Server setup complete' > /tmp/terraform-setup.txt"
    ]
  }
}

# Output the server IP address
output "server_ip" {
  description = "Public IP address of the student server"
  value       = hcloud_server.student_server.ipv4_address
}

# Output instructions for SSH access
output "ssh_instructions" {
  description = "Instructions to connect to the server"
  value       = "ssh -i ${var.student_id}-key.pem root@${hcloud_server.student_server.ipv4_address}"
}
```

**Practice Task 5:**
1. Add the server configuration
2. Run `terraform plan` and examine what will be created
3. Note the server specifications and location
4. Run `terraform apply` and type 'yes' to create resources
5. Verify the server is running in Hetzner Cloud console

---

### **Terraform Commands and Workflow**

**Basic Commands Practice:**

```bash
# Initialize Terraform (download providers, setup backend)
terraform init

# Validate configuration syntax
terraform validate

# Format Terraform files
terraform fmt

# Show execution plan
terraform plan

# Apply changes
terraform apply

# Apply without confirmation prompt
terraform apply -auto-approve

# Show current state
terraform show

# List resources
terraform state list

# Destroy infrastructure
terraform destroy

# Practice Task 6:
# 1. Run each command and understand its purpose
# 2. Use 'terraform show' to see the current state
# 3. Use 'terraform state list' to see managed resources
# 4. Try connecting to your server using the generated SSH key
```

**Understanding Terraform State:**

```bash
# Examine the state file
cat terraform.tfstate

# Show specific resource details
terraform state show hcloud_server.student_server

# Practice Task 7:
# 1. Examine the terraform.tfstate file (it's JSON formatted)
# 2. Use 'terraform state show' to see details of your server
# 3. Note how Terraform tracks the resource IDs and attributes
```

---

### **Adding More Resources**

**Firewall Configuration:**

Create `firewall.tf`:
```hcl
# Create a firewall for the student server
resource "hcloud_firewall" "student_firewall" {
  name = "${var.project_name}-${var.student_id}-fw"

  rule {
    direction  = "in"
    protocol   = "tcp"
    port       = "22"
    source_ips = ["0.0.0.0/0"]
    description = "SSH access"
  }

  rule {
    direction  = "in"
    protocol   = "tcp"
    port       = "80"
    source_ips = ["0.0.0.0/0"]
    description = "HTTP access"
  }

  rule {
    direction  = "in"
    protocol   = "tcp"
    port       = "443"
    source_ips = ["0.0.0.0/0"]
    description = "HTTPS access"
  }

  rule {
    direction  = "in"
    protocol   = "icmp"
    source_ips = ["0.0.0.0/0"]
    description = "ICMP (ping)"
  }
}

# Attach firewall to server
resource "hcloud_firewall_attachment" "student_fw_attachment" {
  firewall_id = hcloud_firewall.student_firewall.id
  server_ids  = [hcloud_server.student_server.id]
}
```

**Practice Task 8:**
1. Add the firewall configuration
2. Run `terraform plan` to see the changes
3. Apply the changes with `terraform apply`
4. Verify the firewall is attached in Hetzner Cloud console

**Volume Resource:**

Create `volume.tf`:
```hcl
# Create additional storage volume
resource "hcloud_volume" "student_volume" {
  name      = "${var.project_name}-${var.student_id}-data"
  size      = 10  # 10GB
  format    = "ext4"
  server_id = hcloud_server.student_server.id

  # Automatically format and mount the volume
  provisioner "remote-exec" {
    inline = [
      "mkfs.ext4 /dev/disk/by-id/scsi-0HC_Volume_${self.id}",
      "mkdir -p /mnt/data",
      "mount /dev/disk/by-id/scsi-0HC_Volume_${self.id} /mnt/data",
      "echo '/dev/disk/by-id/scsi-0HC_Volume_${self.id} /mnt/data ext4 defaults 0 0' >> /etc/fstab"
    ]
  }
}

# Output volume information
output "volume_info" {
  description = "Volume mount information"
  value       = "Volume mounted at /mnt/data on server"
}
```

**Practice Task 9:**
1. Add the volume configuration
2. Apply the changes and verify the volume is created
3. SSH into your server and check if /mnt/data exists
4. Run `df -h` to see the mounted volume

---

### **Variables and Outputs Deep Dive**

**Enhanced Variables:**

Update `variables.tf` with more options:
```hcl
variable "server_size" {
  description = "Hetzner server type"
  type        = string
  default     = "cx11"

  validation {
    condition     = contains(["cx11", "cx21", "cx31", "cpx11", "cpx21"], var.server_size)
    error_message = "Server size must be one of: cx11, cx21, cx31, cpx11, cpx21."
  }
}

variable "server_image" {
  description = "Server operating system image"
  type        = string
  default     = "ubuntu-22.04"
}

variable "datacenter" {
  description = "Hetzner datacenter location"
  type        = string
  default     = "fsn1-dc14"

  validation {
    condition     = contains(["fsn1-dc14", "nbg1-dc3", "hel1-dc2"], var.datacenter)
    error_message = "Datacenter must be one of: fsn1-dc14, nbg1-dc3, hel1-dc2."
  }
}

variable "enable_monitoring" {
  description = "Enable server monitoring"
  type        = bool
  default     = true
}
```

Update `server.tf` to use variables:
```hcl
resource "hcloud_server" "student_server" {
  name        = "${var.project_name}-${var.student_id}"
  image       = var.server_image
  server_type = var.server_size
  datacenter  = var.datacenter
  ssh_keys    = [hcloud_ssh_key.student_ssh_key.id]
  
  # Enable monitoring based on variable
  labels = {
    monitoring = var.enable_monitoring ? "enabled" : "disabled"
  }

  # ... rest of configuration unchanged
}
```

**Practice Task 10:**
1. Update your variables.tf with the enhanced variables
2. Modify server.tf to use the new variables
3. Create a `terraform.tfvars` file with your custom settings:
   ```hcl
   student_id = "student1"
   server_size = "cx21"
   datacenter = "nbg1-dc3"
   enable_monitoring = true
   ```
4. Run `terraform plan` to see how variables affect the configuration

**Enhanced Outputs:**

Create `outputs.tf`:
```hcl
# Server information
output "server_details" {
  description = "Complete server details"
  value = {
    name    = hcloud_server.student_server.name
    id      = hcloud_server.student_server.id
    ip      = hcloud_server.student_server.ipv4_address
    type    = hcloud_server.student_server.server_type
    status  = hcloud_server.student_server.status
  }
}

# Connection information
output "connection_info" {
  description = "How to connect to the server"
  value       = <<EOT
SSH Connection:
  ssh -i ${var.student_id}-key.pem root@${hcloud_server.student_server.ipv4_address}

Server Type: ${hcloud_server.student_server.server_type}
Location: ${hcloud_server.student_server.datacenter}
Created: ${hcloud_server.student_server.created}
EOT
}

# Cost estimation (approximate)
output "estimated_monthly_cost" {
  description = "Approximate monthly cost in EUR"
  value = {
    server = "~€4.51"  # cx11 pricing
    volume = "~€0.60"  # 10GB volume
    total  = "~€5.11"
  }
}
```

**Practice Task 11:**
1. Create the outputs.tf file
2. Run `terraform apply` to see the new outputs
3. Use `terraform output` to view specific outputs
4. Try `terraform output connection_info`

---

### **Terraform Workflow Practice**

**Making Changes:**

```bash
# Let's upgrade our server
# Update your terraform.tfvars to change server_size to "cx21"
server_size = "cx21"

# See what will change
terraform plan

# Apply the change (this will recreate the server!)
terraform apply

# Practice Task 12:
# 1. Change your server size from cx11 to cx21
# 2. Run terraform plan and understand what will happen
# 3. Apply the changes (note: this recreates the server!)
# 4. Verify the new server type in Hetzner Cloud console
```

**Destroy and Recreate:**

```bash
# Destroy your infrastructure
terraform destroy

# Recreate with different configuration
terraform apply

# Practice Task 13:
# 1. Run 'terraform destroy' to remove all resources
# 2. Verify everything is deleted in Hetzner Cloud console
# 3. Change your datacenter location in terraform.tfvars
# 4. Run 'terraform apply' to create infrastructure in new location
```

---

## **Homework Assignment: Terraform Fundamentals**

**Instructions:** Complete the following tasks in your `terraform-basics` directory. Document your work in a `README.md` file.

**Tasks:**

1. **Basic Infrastructure (40 points)**
   Create a complete infrastructure stack that includes:
   - SSH key pair generation and upload
   - Firewall with secure rules (SSH, HTTP, HTTPS, ICMP)
   - Server with your chosen specifications
   - Additional 20GB volume mounted at `/mnt/data`
   - Proper tagging and labels

2. **Configuration Management (30 points)**
   Enhance your configuration with:
   - At least 5 input variables with validation
   - Comprehensive outputs showing all important information
   - Server provisioning that installs nginx and creates a custom homepage
   - Use of `locals` for computed values

3. **Documentation and Best Practices (30 points)**
   Create proper documentation:
   - README.md with setup instructions
   - Variables description and examples
   - State management explanation
   - Cost estimation for your infrastructure

**Example Enhanced Configuration:**

Create `locals.tf`:
```hcl
locals {
  common_tags = {
    Project     = var.project_name
    Student     = var.student_id
    Environment = "training"
    ManagedBy   = "terraform"
  }

  # Generate a unique name with timestamp
  unique_name = "${var.project_name}-${var.student_id}-${formatdate("YYYYMMDD", timestamp())}"
}
```

Create `provisioning.tf`:
```hcl
resource "null_resource" "web_setup" {
  depends_on = [hcloud_server.student_server]

  connection {
    type        = "ssh"
    user        = "root"
    private_key = tls_private_key.student_key.private_key_pem
    host        = hcloud_server.student_server.ipv4_address
  }

  provisioner "remote-exec" {
    inline = [
      # Install nginx
      "apt-get update",
      "apt-get install -y nginx",
      "systemctl enable nginx",
      "systemctl start nginx",
      
      # Create custom homepage
      "echo '<html><body><h1>Hello from ${var.student_id}</h1><p>Server: ${hcloud_server.student_server.name}</p></body></html>' > /var/www/html/index.html",
      
      # Create info file
      "echo 'Terraform Training Server' > /mnt/data/server-info.txt",
      "echo 'Student: ${var.student_id}' >> /mnt/data/server-info.txt",
      "echo 'Created: $(date)' >> /mnt/data/server-info.txt"
    ]
  }
}
```

**Submission Requirements:**
- Complete Terraform code in your directory
- README.md with documentation
- Screenshot of your running infrastructure in Hetzner Cloud
- Output showing successful `terraform apply`
- Cost analysis for your infrastructure

**Bonus Challenge:**
Create a second server that acts as a backup, and use Terraform to configure basic replication between them.

This homework will solidify your understanding of Terraform fundamentals and prepare you for advanced concepts in the next lesson!

[Main](../README.md)
---