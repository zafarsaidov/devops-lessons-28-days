[Main](../README.md)
---

# Using block, rescue, and always

## 1. Core Theory

### What are Blocks?
Blocks are logical groupings of tasks that allow you to:
- Treat multiple tasks as a single unit
- Apply common directives (when, become, etc.) to all tasks in the block
- Implement error handling with rescue and always sections

### Block Structure
```yaml
- block:
    - name: Task 1
      # ... task definition
    
    - name: Task 2
      # ... task definition
  
  rescue:
    - name: Rescue task
      # ... runs only if block fails
  
  always:
    - name: Always task
      # ... runs regardless of block success/failure
```

### Key Facts
- **Block**: Main tasks to execute
- **Rescue**: Runs only if ANY task in block fails
- **Always**: Runs regardless of block success/failure
- **Error Handling**: If rescue fails, playbook stops
- **Variable Scope**: Variables set in block are available in rescue/always


### Cheat Sheet
```yaml
# Basic Block Structure
- block:
    - task1
    - task2
  rescue:
    - rescue_task
  always:
    - cleanup_task

# With Common Directives
- block:
    - task1
    - task2
  when: condition
  become: yes
  rescue:
    - rescue_task

# Nested Blocks
- block:
    - block:
        - inner_task
      rescue:
        - inner_rescue

# Error Handling Control
- block:
    - task
  rescue:
    - rescue_task
  always:
    - cleanup_task
  ignore_errors: yes  # Continue even if rescue fails
```

### Task 1: Basic Error Handling
```yaml
---
- name: Practice Block/Rescue/Always
  hosts: localhost
  connection: local
  gather_facts: false
  
  tasks:
    - name: Basic block with simulated failure
      block:
        - name: Create temporary directory
          ansible.builtin.file:
            path: /tmp/test_block
            state: directory
          register: dir_result
        
        - name: Simulate task failure
          ansible.builtin.command: /bin/false
          when: dir_result is changed
        
        - name: This task won't run if previous fails
          ansible.builtin.debug:
            msg: "This only shows if all block tasks succeed"
      
      rescue:
        - name: Handle block failure
          ansible.builtin.debug:
            msg: "Block failed! Handling error..."
        
        - name: Show error details
          ansible.builtin.debug:
            msg: |
              Failed task: {{ ansible_failed_task.name }}
              Failed result: {{ ansible_failed_result }}
      
      always:
        - name: Cleanup temporary directory
          ansible.builtin.file:
            path: /tmp/test_block
            state: absent
          when: dir_result is changed
        
        - name: Always runs regardless
          ansible.builtin.debug:
            msg: "This always executes, success or failure"
```

### What are Handlers?
Handlers are special tasks that run only when notified by other tasks. They are typically used for service restarts, reloads, and other actions that should only occur when changes are made.

### Handler Execution Flow
```
┌─────────────────┐    notify    ┌──────────────────┐
│ Regular Task    │─────────────▶│   Handler Task   │
│ (changed: true) │              │ (queued to run)  │
└─────────────────┘              └──────────────────┘
                                       │
┌─────────────────┐    notify         │
│ Another Task    │───────────────────┘
│ (changed: true) │                   
└─────────────────┘                   
                                       ▼
                                ┌──────────────────┐
                                │ Handler Executes │
                                │ (at play end)    │
                                └──────────────────┘
```

### Key Concepts

**Notification**: Triggering a handler from a task using `notify`
**Handler**: The actual task that runs in response to notification
**Flushing**: Handlers run at the end of each play by default
**Multiple Notifications**: Handler runs only once even if notified multiple times
**Listeners**: Handlers that can be triggered by multiple names

### Cheat Sheet

```yaml
# Basic Handler Definition
handlers:
  - name: restart nginx
    service:
      name: nginx
      state: restarted

  - name: reload nginx
    service:
      name: nginx
      state: reloaded

# Task Notifying Handler
- name: Update nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: restart nginx

# Multiple Notifications
- name: Configure multiple services
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - { src: 'app.conf.j2', dest: '/etc/app.conf' }
    - { src: 'db.conf.j2', dest: '/etc/db.conf' }
  notify:
    - restart app
    - restart db

# Using listen for multiple triggers
handlers:
  - name: restart services
    service:
      name: "{{ item }}"
      state: restarted
    listen: "restart multiple services"

# Force handler execution
- meta: flush_handlers
```

### What are Jinja2 Templates?
Jinja2 is a modern and designer-friendly templating language for Python, used by Ansible to generate dynamic configuration files. Templates allow you to create files with placeholders that get replaced with actual values during playbook execution.

### Template Processing Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Template File   │    │ Ansible         │    │ Rendered File   │
│ (.j2) with      │───▶│ Template Module │───▶│ with actual     │
│ Variables       │    │ + Variables     │    │ values          │
│ {{ variable }}  │    │                 │    │ substituted     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Key Jinja2 Syntax Elements

**Variables**: `{{ variable_name }}`
**Expressions**: `{{ list_var[0] }}`, `{{ dict_var.key }}`
**Conditionals**: `{% if condition %}...{% endif %}`
**Loops**: `{% for item in list %}...{% endfor %}`
**Filters**: `{{ variable | filter }}`
**Comments**: `{# comment #}`

### Cheat Sheet

```jinja2
{# Basic Variable Substitution #}
server_name {{ domain_name }};
port {{ app_port }};

{# Conditional Blocks #}
{% if environment == "production" %}
log_level error;
{% else %}
log_level debug;
{% endif %}

{# Loops #}
{% for server in backend_servers %}
server {{ server.ip }}:{{ server.port }};
{% endfor %}

{# Filters #}
{{ database_host | upper }}
{{ user_list | join(",") }}
{{ config_string | quote }}

{# Including other templates #}
{% include 'common/header.j2' %}

{# Macros for reusable components #}
{% macro service_entry(name, port) %}
service {{ name }} {
    port {{ port }};
}
{% endmacro %}

{# Using the macro #}
{{ service_entry("web", 80) }}
{{ service_entry("api", 8080) }}
```

### Use Case 1: Nginx Virtual Host Template
```jinja2
{# nginx-vhost.j2 - Production nginx virtual host #}
# Ansible Managed - DO NOT EDIT
# Virtual Host: {{ server_name }}

server {
    {% if ssl_enabled %}
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    ssl_certificate {{ ssl_cert_path }};
    ssl_certificate_key {{ ssl_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    {% else %}
    listen 80;
    listen [::]:80;
    {% endif %}
    
    server_name {{ server_name }};
    root {{ document_root }};
    index index.html index.htm index.php;
    
    access_log /var/log/nginx/{{ server_name }}_access.log;
    error_log /var/log/nginx/{{ server_name }}_error.log;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # PHP handling
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php{{ php_version }}-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    # Static assets caching
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    {% if basic_auth_enabled %}
    # Basic authentication
    auth_basic "Restricted Area";
    auth_basic_user_file /etc/nginx/.htpasswd_{{ server_name }};
    {% endif %}
    
    {% if redirect_www %}
    # WWW redirect
    server_name www.{{ server_name }};
    return 301 https://{{ server_name }}$request_uri;
    {% endif %}
}
```

**Template: loadbalancer.j2**
```jinja2
{# loadbalancer.j2 - Complex template with error handling #}
# Load Balancer Configuration
# Name: {{ load_balancer.name }}

{# Global settings #}
global
    daemon
    maxconn {{ load_balancer.max_connections | default(5000) }}
    log 127.0.0.1 local0 info

{# Defaults section with error checking #}
defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect {{ load_balancer.timeouts.connect | default("5000") }}
    timeout client {{ load_balancer.timeouts.client | default("50000") }}
    timeout server {{ load_balancer.timeouts.server | default("50000") }}
    retries {{ load_balancer.retries | default(3) }}
    
{# Frontend configuration #}
frontend http_front
    bind *:{{ load_balancer.frontend.port }}
    {% if load_balancer.frontend.ssl %}
    bind *:443 ssl crt {{ load_balancer.frontend.ssl_cert }}
    redirect scheme https if !{ ssl_fc }
    {% endif %}
    
    {# ACL definitions #}
    {% for backend in load_balancer.backends %}
    acl is_{{ backend.name }} path_beg -i {{ backend.health_check }}
    {% endfor %}
    
    {# Routing rules #}
    {% for backend in load_balancer.backends %}
    use_backend {{ backend.name }}_backend if is_{{ backend.name }}
    {% endfor %}
    
    default_backend web_backend

{# Backend configurations #}
backend web_backend
    balance roundrobin
    option httpchk GET /health
    
    {# Server entries with validation #}
    {% for backend in load_balancer.backends %}
    {% if backend.address and backend.port %}
    server {{ backend.name }} {{ backend.address }}:{{ backend.port }} weight {{ backend.weight | default(1) }} check inter {{ monitoring.interval | default(30) }}s fall 3 rise 2
    {% else %}
    {# Error handling for missing backend config #}
    # WARNING: Incomplete configuration for {{ backend.name }}
    {% endif %}
    {% endfor %}

{# Monitoring configuration if enabled #}
{% if monitoring.enabled %}
listen stats
    bind *:1936
    stats enable
    stats uri /haproxy?stats
    stats realm Haproxy\ Statistics
    stats auth admin:{{ monitoring.stats_password | default("password") }}
    
    {# Alert configuration #}
    {% if monitoring.alerts %}
    # Alert recipients
    {% for alert in monitoring.alerts %}
    # {{ alert }}
    {% endfor %}
    {% endif %}
{% endif %}

{# Validation and error reporting #}
{% if load_balancer.backends | length == 0 %}
# ERROR: No backends configured!
{% endif %}

{% if not load_balancer.frontend.ssl_cert and load_balancer.frontend.ssl %}
# WARNING: SSL enabled but no certificate specified
{% endif %}
```

### Cheat Sheet: Essential Filters

```jinja2
{# STRING FILTERS #}
{{ string_var | upper }}               {# Convert to uppercase #}
{{ string_var | lower }}               {# Convert to lowercase #}
{{ string_var | capitalize }}          {# Capitalize first letter #}
{{ string_var | replace("old", "new") }} {# Replace substring #}
{{ string_var | regex_replace(pattern, replacement) }}

{# LIST FILTERS #}
{{ list_var | length }}                {# Get list length #}
{{ list_var | first }}                 {# Get first element #}
{{ list_var | last }}                  {# Get last element #}
{{ list_var | join(",") }}             {# Join with delimiter #}
{{ list_var | sort }}                  {# Sort list #}
{{ list_var | unique }}                {# Remove duplicates #}

{# MATH FILTERS #}
{{ number_var | int }}                 {# Convert to integer #}
{{ number_var | float }}               {# Convert to float #}
{{ number_var | abs }}                 {# Absolute value #}
{{ number_var | round }}               {# Round number #}
{{ (bytes | int) / 1048576 }}          {# Convert bytes to MB #}

{# DATA TYPE FILTERS #}
{{ var | default("default_value") }}   {# Provide default #}
{{ var | bool }}                       {# Convert to boolean #}
{{ var | to_json }}                    {# Convert to JSON #}
{{ var | to_yaml }}                    {# Convert to YAML #}

{# SELECTION FILTERS #}
{{ list | selectattr("enabled") }}     {# Filter objects by attribute #}
{{ list | rejectattr("active") }}      {# Exclude objects by attribute #}
{{ list | map(attribute="name") }}     {# Extract attribute values #}

{# COMBINATION FILTERS #}
{{ list | selectattr("active") | map(attribute="name") | join(",") }}
```


[Main](../README.md)
---